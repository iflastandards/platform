# IFLA Standards Platform Scripts

This directory contains utility scripts for the IFLA Standards Platform.

## Sidebar Reference Validation

The sidebar reference validation script checks that all document IDs referenced in a site's sidebar configuration have corresponding files in the site's docs directory.

### Usage

```bash
# Validate all sites
pnpm tsx scripts/nx-validate-sidebar-references.ts

# Validate specific sites
pnpm tsx scripts/nx-validate-sidebar-references.ts isbd lrm

# Using Nx
nx run scripts:validate-sidebar --args.site=isbd
```

### What It Does

1. Extracts all document IDs from the sidebar configuration
2. Expands autogenerated directory references to include all files in those directories
3. Checks if files exist for all document IDs
4. Generates a report of missing files

### Output

The script will output a report of missing files, if any:

```
Validating sidebar references for isbd...
Found 15 references in sidebar
Expanded to 42 total references

Found 3 missing files referenced in sidebar:

## Missing Document Files

- `elements/unconstrained/index` (Expected at: `/path/to/standards/isbd/docs/elements/unconstrained/index.mdx`)
- `vocabularies/contentformbase` (Expected at: `/path/to/standards/isbd/docs/vocabularies/contentformbase.mdx`)

## Missing Autogenerated Directories

- `vocabularies/contentformbase` (Expected at: `/path/to/standards/isbd/docs/vocabularies/contentformbase`)

### Recommendation

Create the missing files to ensure the site builds correctly.
```

If all files exist, the script will output:

```
Validating sidebar references for isbd...
Found 15 references in sidebar
Expanded to 42 total references

All sidebar references have corresponding files. âœ…
```

### Exit Codes

- `0`: All files exist
- `1`: Missing files or error

## Development

### Testing

```bash
# Run all script tests
pnpm test:scripts

# Run specific test file
pnpm test:scripts:file scripts/utils/sidebar-reference-extractor.test.ts

# Run tests in watch mode
pnpm test:scripts:watch
```

## Vocabulary Comparison Tool

The vocabulary comparison script compares Google Sheets SKOS concepts with published RDF vocabularies.

### Usage

```bash
# Run the comparison tool
node scripts/vocabulary-comparison.mjs
```

### Testing

```bash
# Run vocabulary comparison tests
pnpm test packages/theme/src/tests/scripts/vocabulary-comparison.test.ts
```

#### Test Details

- **Test file**: `packages/theme/src/tests/scripts/vocabulary-comparison.test.ts`
- **Script being tested**: `scripts/vocabulary-comparison.mjs`

#### Key Testing Challenges Solved

1. **Fetch Mocking**
   - The script uses `globalThis.fetch` which requires special mocking approach
   - Solution: Use `vi.stubGlobal('fetch', mockFetch)` before importing the module

2. **Constructor API Calls**
   - The constructor calls `getAvailableSheets()` which makes an API request
   - Tests must provide a default mock response for all instances

3. **API Response Differences**
   - `fetchSheetData` returns `data.values || []` not the full response object
   - Tests must match actual return values, not Google Sheets API structure

#### Test Coverage

The test suite covers 34 test cases across these areas:

1. **Constructor** - Default and custom options initialization
2. **API Methods** 
   - `getAvailableSheets()` - Fetching and parsing sheet metadata
   - `fetchSheetData()` - Fetching sheet content
3. **Parsing Methods**
   - `parseColumnHeader()` - Parsing SKOS property headers with language/index
   - `organizeColumns()` - Grouping columns by property and language
   - `extractPropertyValues()` - Extracting values with language fallback
4. **Matching Logic**
   - `findMatchingSheet()` - Token/title matching with special patterns
5. **Validation**
   - `isInstructionRow()` - Identifying non-data rows
   - `hasValidRdfUri()` - URI validation