# User Administration Resource Policy
# Defines permissions for managing user roles and assignments.
---
apiVersion: api.cerbos.dev/v1
resourcePolicy:
  version: "default"
  resource: "user_admin"
  importDerivedRoles:
    - ifla_standards_roles
  rules:
    # Superadmins can manage all users and roles.
    - actions: ["*"]
      effect: EFFECT_ALLOW
      derivedRoles: ["superadmin"]

    # Namespace admins can manage users within their namespace.
    - actions: ["view_users", "assign_roles", "remove_roles"]
      effect: EFFECT_ALLOW
      derivedRoles: ["namespace_admin"]
      condition:
        match:
          # Ensures they are acting within the scope of their namespace.
          expr: R.attr.namespace == P.attr.namespaces.keys().find(k, P.attr.namespaces[k] == "admin")

    # Users can view their own role assignments.
    - actions: ["view_own_roles"]
      effect: EFFECT_ALLOW
      roles: ["user"]
      condition:
        match:
          expr: P.id == R.attr.userId

    # Prevent privilege escalation.
    - actions: ["assign_roles"]
      effect: EFFECT_DENY
      derivedRoles: ["namespace_admin"]
      condition:
        match:
          expr: 'R.attr.targetRole == "superadmin"'
